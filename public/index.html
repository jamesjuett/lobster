<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>-->
    <script src="codemirror-compressed.js"></script>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="jquery.mousewheel.min.js"></script>
    <script src="peg-0.8.0.min.js"></script>
    <script src="svg.min.js"></script>
    <script src="seedrandom.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
    Remove this if you use the .htaccess -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Lobster</title>
    <meta name="description" content="" />
    <meta name="author" content="James" />
    <meta name="google-signin-client_id" content="355743019649-mrm7gtmkujj5gicc4rftl0ckm959ui7d.apps.googleusercontent.com">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="stylesheet" href="codemirror.css">
    <link rel="stylesheet" href="monokai.css">
    <link rel="stylesheet" href="lobster.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="code.css">

    <script src = "diff_match_patch.js"></script>
    <script src = "underscore-min.js"></script>
    <script src = "math.min.js"></script>
    <script src = "util.js"></script>
    <script src = "entities.js"></script>
    <script src = "outlet.js"></script>
    <script src = "mymath.js"></script>
    <script src = "codeDisplay.js"></script>
    <script src = "internals.js"></script>
    <script src = "error.js"></script>
    <script src = "types.js"></script>
    <script src = "expressions.js"></script>
    <script src = "declarations.js"></script>
    <script src = "statements.js"></script>
    <script src = "control.js"></script>
    <script src = "Simulation.js"></script>
    <script src = "CPPOutlets.js"></script>
    <script src = "parsing.js"></script>
    <script src = "parsing2.js"></script>

</head>

<body>
<div class="fill" style="margin-left: auto; margin-right: auto">
    <div class="fill" id="main_area" style="display:flex; flex-direction: column;-webkit-flex-direction: column;-ms-flex-direction: column;">
        <div style="text-align: center; flex:0 1 auto;-webkit-flex:0 1 auto; -ms-flex:0 1 auto">
            <h2 class="labsterTitle">Lobster</h2>
            <div class="g-signin2" data-onsuccess="onSignIn"></div>
            <div style="font-size: 8pt; color: red">If possible, please use Google Chrome for Lobster. It runs poorly on other browsers. Sorry for the inconvenience!</div>
            (<a href="https://drive.google.com/file/d/0B49xEM_rtERAMHRFZW5oREdGdjA/view?usp=sharing" target="_blank">Usage Guide</a>)
            <!--(Press the "s" or "->" key to step forward, or scroll while holding ctrl)-->
        </div>
        <!--<textarea class="debug log" style="width: 800px; height: 50px"> </textarea>-->
        <!--<input type="text" class="codeSelect" name ="codeSelect" />-->
        <div id="labster1" style="display:flex; align-items: stretch;-webkit-align-items: stretch;-ms-align-items: stretch; flex: 1 1 auto; -webkit-flex: 1 1 auto; -ms-flex: 1 1 auto; margin-top: 5px; margin-bottom: 5px; overflow-y: scroll">
            <div style="width: 175px; margin-right: 5px; display: flex; flex-direction:column;-webkit-flex-direction: column;-ms-flex-direction: column; align-items: stretch;-webkit-align-items: stretch;-ms-align-items: stretch;">
                <div style="margin-top: 2ch; text-align: center">My Code</div>
                <div style="text-align: center; font-size: 7pt">(Check the box to make the code public.)</div>
                <div class = "codeList codeListMe" style="flex: 1 1 100px;-webkit-flex: 1 1 100px;-ms-flex: 1 1 100px; overflow-y: auto; "></div>
                <div style="margin-top: 2ch; text-align: center">EECS280 Code</div>
                <div class = "codeList codeListAll" style="flex: 1 1 100px; -webkit-flex: 1 1 100px; -ms-flex: 1 1 100px; overflow-y: auto; "></div>
                <div style="margin-top: 2ch; text-align: center">A Friend's Code</div>
                <span style="font-size: 7pt">Email:</span><input class="friendsUniqname" style="width: 100px" type="text" maxlength="100" value="uniqname" />
                <span style="font-size: 7pt">Code Name:</span><input class="friendsProgramName" style="width: 100px" type="text" maxlength="30" value="program.cpp" />
                <button class="friendCodeButton">Find</button>
            </div>
            <!--<div class="debug execStack" style="width: 125px; margin-right: 5px; display: flex; flex-direction:column;-webkit-flex-direction: column;-ms-flex-direction: column; align-items: stretch;-webkit-align-items: stretch;-ms-align-items: stretch;"></div>-->
            <!-- <div  class="codeArea" style = "display: block; position: absolute; min-height: 300px; width: 300px;">
                <div id = "codeAreaShadow" style = "background: none; border: none; display: block; position: relative; margin: 0; padding: 0;"></div>
            </div> -->
            <div style="flex: 1 1 auto;-webkit-flex: 1 1 auto;-ms-flex: 1 1 auto; display: flex; flex-direction: column;-webkit-flex-direction: column;-ms-flex-direction: column;">
                <div class="tabs" style="flex: 0 0 auto;-webkit-flex: 0 0 auto;-ms-flex: 0 0 auto;">
                    <span class="sourceTab" class="active">Source Code</span>
                    <span class="simTab">Simulation</span>
                </div>
                <div class = "tabPanes" style="position: relative; background-color: ghostwhite; flex: 1 1 auto;-webkit-flex: 1 1 auto;-ms-flex: 1 1 auto;">
                    <div class="sourcePane" style="display: flex; flex-direction: column;-webkit-flex-direction: column;-ms-flex-direction: column">
                        <div style= "padding:2px">
                            <input class="saveName" type="text" maxlength="30" value="" />
                            <button class="saveButton">Save</button>
                            <span class="saveMessage" style="display: none">Saving...</span>
                        </div>
                        <div style = "height: 22px; padding: 2px; background-color: lightgray;flex: 0 0 auto;-webkit-flex: 0 0 auto;-ms-flex: 0 0 auto;">
                            <button class = "runButton" style="display: inline-block">Simulate</button>
                            <span class="status"></span>
                        </div>
                        <ul class = "semanticProblems" style = "width: 100%; max-height: 100px; overflow-y: auto; box-sizing: border-box;"></ul>
                        <div class="codeMirrorEditor" style = "position: relative; overflow-y: auto; flex: 1 1 auto;-webkit-flex: 1 1 auto;-ms-flex: 1 1 auto; background-color: #272822">
                            <!--<textarea style="position: absolute; overflow-y: hidden; height: 2000px; color: black"></textarea>-->
                            <!--<div style="height: 400px;"></div>-->
                        </div>

                        <div class="annotationMessagesContainer" style="position: absolute; bottom: 0; left: 0px; right: 0px; overflow: hidden; text-align: center; pointer-events: none">
                            <div class="annotationMessages">
                                <div style="height: 100px; margin-left: 5px; float: right;">
                                    <img src="lobster_teaching.jpg" class="lobsterRecursionImage" style="height: 90px; margin-left: 5px;"/>
                                    <img src="lobster_recursion.jpg" class="lobsterTeachingImage" style="display:none; height: 90px; margin-left: 5px;"/>
                                    <div style="padding-right: 5px; text-align: center"><button>Thanks!</button></div>
                                </div>
                                <div style="height: 100%; overflow-y: auto"><table style="height: 110px; margin-left: auto; margin-right: auto"><tr><td><div class="annotation-message"></div></td></tr></table></div>
                            </div>
                        </div>





                    </div>
                    <div class="simPane" style="display: none; flex-direction: column;-webkit-flex-direction: column;-ms-flex-direction: column; padding: 5px" tabindex="0">
                        <div style="margin-bottom: 5px;">
                            <button class = "restart">Restart</button>
                            <!--<span style = "display: inline-block; width: 4ch"></span>-->
                            <input type="text" style="display: none; width: 4ch" class="stepForwardNum" value="1" />
                            <button class = "stepForward">Step Forward</button>
                            <button class = "stepOver">Step Over</button>
                            <button class = "stepOut">Step Out</button>
                            <button class = "runToEnd">Run</button>
                            <button class = "pause">Pause</button>
                            <button class = "skipToEnd">Skip to End (FAST)</button>

                            <!--Show Functions<input type="checkbox" class="stepInto"/>-->
                            <button class = "stepBackward">Step Backward</button>
                            <input type="text" style="width: 4ch" class="stepBackwardNum" value="1" />
                            <!--<input type="checkbox" id="tcoCheckbox" checked="false" />-->
                        </div>
                        <div style="position: relative">
                            <div class="runningProgress" style="position: absolute; right: 0; top: 0; margin: 5px; margin-right: 20px; padding: 5px; background-color: rgba(255,255,255,0.7);">
                                Thinking...
                                <!--<progress style="display: inline-block; vertical-align: top"></progress>-->
                            </div>
                            <div class="alerts-container">
                                <div class="alerts">
                                    <div style="display:inline-block; padding: 5px">
                                        <div style="height: 100px; margin-left: 5px; float: right;">
                                            <img src="lobster.png" style="height: 80px; margin-left: 5px;"/>
                                            <div style="padding-right: 5px; text-align: right"><button>Dismiss</button></div>
                                        </div>
                                        <table style="height: 110px"><tr><td><div class="alerts-message"></div></td></tr></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- <p style = "width: 394px; padding: 5px;" class = "_outlet readOnly memory">memory</p> -->
                        <div style="flex: 1 1 200px;-webkit-flex: 1 1 200px;-ms-flex: 1 1 200px; display: flex;">
                            <div style="display:flex; flex-direction: column;-webkit-flex-direction: column;-ms-flex-direction: column">
                                <div style = "text-align: center">Console</div>
                                <div style="position: relative; min-height: 80px">
                                    <div class="console" style="min-height: 20px; resize: both; left: 0; right: 0; top: 0; bottom: 0; background-color: rgba(255,255,255,0.7);"></div>
                                </div>
                                <div style = "text-align: center">Memory</div>
                                <div class = "" style="flex: 1 1 0;-webkit-flex: 1 1 0;-ms-flex: 1 1 0; overflow-y: auto; width: 200px; overflow-x: hidden;"><div class="memory readOnly"></div></div>

                            </div>
                            <div class = "stackFrames readOnly" style="display: block; margin-left: 5px; overflow-y: auto; flex: 1 1 auto;-webkit-flex: 1 1 auto;-ms-flex: 1 1 auto; text-wrap: avoid; position: relative; white-space: nowrap;"> </div>
                        </div>

                        <!-- <p style = "width: 394px; padding: 5px;" class = "_outlet readOnly memory">memory</p> -->

                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        var ID_TOKEN = "";

        var handleWhoAmI = function(data){
            data.lab2group = "2"; // hack to make everyone have Maize
            if (data.lab2group === "1"){
//                $(".labsterTitle").append(" <span style='color:blue'>BLUE</span>");
                Outlets.CPP.SimulationOutlet.useSourceSimulation = true;
            }
            else if (data.lab2group === "2"){
//                $(".labsterTitle").append(" <span style='color:gold'>MAIZE</span>");
                Outlets.CPP.SimulationOutlet.useSourceSimulation = false;
            }
            else{
                // No group?
                Outlets.CPP.SimulationOutlet.useSourceSimulation = false;
            }
//                Outlets.CPP.PointerMemoryObject.showPtdArray = false;

            var simOutlet = Outlets.CPP.SimulationOutlet.instance($("#labster1"), simulation);
//          var simOutlet2 = Outlets.CPP.SimulationOutlet.instance($("#labster2"), Simulation.instance());

            var elem = $(".codeListAll");
            var codeList = CodeList.instance(elem, "api/", simOutlet.editor, false);
            simOutlet.listenTo(codeList);

            elem = $(".codeListMe");
            codeList = CodeList.instance(elem, "api/me/", simOutlet.editor, true);
            simOutlet.listenTo(codeList);


            $(".friendCodeButton").click(function(){
                codeList.loadCode($(".friendsProgramName").val(), $(".friendsUniqname").val());
            });

            codeList.loadCode(data.lastFile);


            var dcCount = 0;
            setInterval(function(){

                if (CodeList.ajaxSuccessful){
                    $.ajax({
                        type: "GET",
                        url: "api/ping",
                        success: function(xhr, statusText){
                            dcCount = 0;
                        },
                        error: function(xhr, statusText){
                            console.log("Ping failed " + (dcCount+1) + " times.");
                            if (dcCount > 2){
                                alert("Uh oh. It looks like you're not logged in anymore (or your internet/wireless may have died for a moment). You may want to copy the contents of the current editor just in case you didn't save earlier. Then try reloading the page to log in again.");
                                dcCount = 0;
                            }
                            else{
                                ++dcCount;
                            }
                        }
                    });
                }
            }, 10000);

            setInterval(function(){
                if (!simOutlet.editor.saved){
                    simOutlet.saveFunc(true);
                }
            }, 30000);
//        simOutlet.editor.listenTo(codeList);




//            var temp = "int fib(int n){\n  if (n <= 2)\n    return 1;\n  else\n    return fib(n-1) + fib(n-2);\n}\n\nint main(){\n  int x = 3;\n  int y = 4;\n  int *ptr = new int;\n  int *ptr2 = &x;\n  int **dPtr = &ptr2;\n  **dPtr = 5;\n  y = x = *ptr;\n\n  x = fib(4);\n}";
//            // $("#codeArea textarea").val(temp);
//            simulation.code.setValue(temp);

            createDefaultOutlets();

//        tinymce.init({
//            selector: ".codeArea textarea",
//            nowrap: true,
////            setup: function(ed){
////                ed.on("keydown", function(evt) {
////                   if (evt.keyCode == 9){
////                       if (evt.shiftKey) {
////                           ed.execCommand("Outdent");
////                       }
////                       else{
////                           ed.execCommand("Indent");
////                       }
////                       evt.preventDefault();
////                   }
////                });
////            }
//        });



        };

        function onSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail());
            ID_TOKEN = googleUser.getAuthResponse().id_token;

//        var xhr = new XMLHttpRequest();
//        xhr.open('POST', 'api/login');
//        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
//        xhr.onload = function() {
//            console.log('Signed in as: ' + xhr.responseText);
//        };
//        xhr.send('idtoken=' + id_token);

            $.ajax({
                type: "POST",
                url: "api/whoami",
                data: {idtoken: ID_TOKEN},
                success: function(data){
                    handleWhoAmI(data);
                },
                error: function(){
                    handleWhoAmI({
                        lastProgram : "program.cpp",
                        lab2Group: 2
                    });
                },
                dataType: "json"
            });
        }
        var simulation = Simulation.instance();

/*        $(document).ready(function() {


                    handleWhoAmI({
                        lastProgram : "program.cpp",
                        lab2Group: 2
                    });




        });
*/


    </script>
</body>
</html>
